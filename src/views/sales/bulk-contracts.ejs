<%- include('../partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-1">批次新增合約</h1>
    <p class="text-muted mb-0">一次輸入多位客戶，立即產生簽署連結與驗證碼。</p>
  </div>
  <div class="d-flex gap-2">
    <a href="/sales" class="btn btn-outline-secondary">返回列表</a>
  </div>
</div>

<% if (flashMessage) { %>
  <div class="alert alert-info" role="alert">
    <%= flashMessage %>
  </div>
<% } %>

<div class="card shadow-sm">
  <div class="card-body">
    <form action="/sales/contracts/bulk" method="POST" id="bulk-form">
      <div class="row g-3 align-items-end">
        <div class="col-lg-6">
          <label class="form-label" for="template-select">選擇合約範本</label>
          <select class="form-select" id="template-select" name="template_id" required>
            <option value="" disabled selected>-- 請選擇範本 --</option>
            <% templates.forEach(template => { %>
              <option value="<%= template.id %>"><%= template.name %></option>
            <% }) %>
          </select>
          <div class="form-text">範本變數會套用到下方每一列客戶。</div>
        </div>
        <div class="col-lg-6 text-lg-end">
          <div class="d-flex gap-2 justify-content-lg-end flex-wrap">
            <button type="button" class="btn btn-outline-secondary" id="add-entry">新增一列客戶</button>
            <button type="button" class="btn btn-outline-primary" id="copy-first-entry">同步第一列至其他</button>
          </div>
        </div>
      </div>

      <div id="entries-container" class="mt-3"></div>

      <div class="alert alert-light border mt-3">
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-primary">提示</span>
          <span>至少填寫一位客戶名稱；送出後每列會建立一份合約，狀態為「待簽署」。</span>
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a href="/sales" class="btn btn-secondary">取消</a>
        <button type="submit" class="btn btn-primary">批次建立合約</button>
      </div>
    </form>
  </div>
</div>

<%- include('../partials/footer') %>

<script>
  const templateSelect = document.getElementById('template-select');
  const entriesContainer = document.getElementById('entries-container');
  const addEntryButton = document.getElementById('add-entry');
  const copyFirstButton = document.getElementById('copy-first-entry');
  const form = document.getElementById('bulk-form');

  let currentVariables = [];
  let entryIndex = 0;

  function escapeAttr(value) {
    const div = document.createElement('div');
    div.textContent = value ?? '';
    return div.innerHTML;
  }

  function buildVariableFields(entryId, existingValues = {}) {
    if (!currentVariables.length) {
      return '<p class="text-muted mb-0">請先選擇範本，系統會自動載入變數欄位。</p>';
    }
    return currentVariables.map(variable => {
      const key = variable.key || variable.name;
      const label = variable.label || variable.name || '變數';
      const type = (variable.type || 'text').toLowerCase();
      const options = Array.isArray(variable.options) ? variable.options : [];
      const safeKey = escapeAttr(key);
      const safeLabel = escapeAttr(label);
      const value = existingValues[key] || '';
      const safeValue = escapeAttr(value);
      const inputId = `entry-${entryId}-var-${safeKey}`;
      const isChecked = value === true || value === 'true' || value === 'on' || value === '1' || value === 1 || value === '已勾選';

      if (type === 'textarea') {
        return `
          <div class="col-md-6">
            <label class="form-label" for="${inputId}">${safeLabel}</label>
            <textarea class="form-control" id="${inputId}" name="entries[${entryId}][variables][${safeKey}]" rows="3">${safeValue}</textarea>
          </div>
        `;
      }

      if (type === 'checkbox') {
        return `
          <div class="col-md-6">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="${inputId}" name="entries[${entryId}][variables][${safeKey}]" value="on" ${isChecked ? 'checked' : ''}>
              <label class="form-check-label" for="${inputId}">${safeLabel}</label>
            </div>
          </div>
        `;
      }

      if (type === 'select') {
        const optionsHtml = options.map(opt => {
          const escapedOpt = escapeAttr(opt);
          const selected = value === opt ? 'selected' : '';
          return `<option value="${escapedOpt}" ${selected}>${escapedOpt}</option>`;
        }).join('');
        return `
          <div class="col-md-6">
            <label class="form-label" for="${inputId}">${safeLabel}</label>
            <select class="form-select" id="${inputId}" name="entries[${entryId}][variables][${safeKey}]">
              <option value="" ${value ? '' : 'selected'} disabled>-- 請選擇 --</option>
              ${optionsHtml}
            </select>
          </div>
        `;
      }

      return `
        <div class="col-md-6">
          <label class="form-label" for="${inputId}">${safeLabel}</label>
          <input type="${['number','date'].includes(type) ? type : 'text'}" class="form-control" id="${inputId}" name="entries[${entryId}][variables][${safeKey}]" value="${safeValue}">
        </div>
      `;
    }).join('');
  }

  function renderVariableFieldsForRow(rowEl, existingValues) {
    const container = rowEl.querySelector('.variable-fields');
    container.innerHTML = buildVariableFields(rowEl.dataset.entryId, existingValues);
  }

  function addEntry(prefill = {}) {
    const id = entryIndex++;
    const wrapper = document.createElement('div');
    wrapper.className = 'border rounded-3 p-3 mb-3 bg-white';
    wrapper.dataset.entryId = id;

    wrapper.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>客戶資料</strong>
        <button type="button" class="btn btn-sm btn-outline-danger remove-entry">移除此列</button>
      </div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label" for="client-${id}">客戶名稱</label>
          <input type="text" class="form-control" id="client-${id}" name="entries[${id}][client_name]" value="${escapeAttr(prefill.client_name || '')}" placeholder="例如：王小明" required>
        </div>
      </div>
      <div class="row g-3 mt-1 variable-fields"></div>
    `;

    entriesContainer.appendChild(wrapper);
    renderVariableFieldsForRow(wrapper, prefill.variables || {});
    refreshRemoveButtons();
  }

  function refreshRemoveButtons() {
    const rows = entriesContainer.querySelectorAll('.remove-entry');
    rows.forEach(btn => {
      btn.disabled = entriesContainer.children.length <= 1;
    });
  }

  async function fetchTemplateVariables(templateId) {
    if (!templateId) {
      currentVariables = [];
      entriesContainer.querySelectorAll('.variable-fields').forEach(container => {
        container.innerHTML = buildVariableFields(container.closest('[data-entry-id]').dataset.entryId);
      });
      return;
    }
    try {
      const res = await fetch(`/api/templates/${templateId}`);
      if (!res.ok) {
        throw new Error('無法載入範本資料');
      }
      const data = await res.json();
      currentVariables = Array.isArray(data.variables) ? data.variables : [];
      entriesContainer.querySelectorAll('.variable-fields').forEach(container => {
        renderVariableFieldsForRow(container.closest('[data-entry-id]'));
      });
    } catch (err) {
      currentVariables = [];
      entriesContainer.querySelectorAll('.variable-fields').forEach(container => {
        container.innerHTML = `<p class="text-danger mb-0">${err.message}</p>`;
      });
    }
  }

  addEntryButton.addEventListener('click', () => addEntry());

  function copyFirstEntryToOthers() {
    const rows = Array.from(entriesContainer.querySelectorAll('[data-entry-id]'));
    if (rows.length < 2) {
      alert('請先新增至少兩列客戶資料。');
      return;
    }
    const firstRow = rows[0];
    const sourceName = firstRow.querySelector('input[name$="[client_name]"]')?.value || '';

    rows.slice(1).forEach(row => {
      const targetName = row.querySelector('input[name$="[client_name]"]');
      if (targetName) {
        targetName.value = sourceName;
      }

      const sourceFields = firstRow.querySelectorAll('input[name*="[variables]"], textarea[name*="[variables]"]');
      sourceFields.forEach(field => {
        const match = field.name.match(/\[variables]\[([^\]]+)]/);
        if (!match) return;
        const key = match[1];
        const target = row.querySelector(`[name="entries[${row.dataset.entryId}][variables][${key}]"]`);
        if (!target) return;
        if (field.type === 'checkbox') {
          target.checked = field.checked;
        } else {
          target.value = field.value;
        }
      });
    });
  }

  copyFirstButton.addEventListener('click', copyFirstEntryToOthers);

  entriesContainer.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-entry')) {
      e.target.closest('[data-entry-id]').remove();
      refreshRemoveButtons();
    }
  });

  templateSelect.addEventListener('change', (e) => {
    fetchTemplateVariables(e.target.value);
  });

  form.addEventListener('submit', (e) => {
    if (!templateSelect.value) {
      e.preventDefault();
      alert('請先選擇範本再送出。');
      return;
    }
    const nameInputs = Array.from(form.querySelectorAll('input[name^="entries"][name$="[client_name]"]'));
    const hasName = nameInputs.some(input => input.value.trim().length > 0);
    if (!hasName) {
      e.preventDefault();
      alert('請至少填寫一位客戶名稱。');
    }
  });

  // 初始化
  addEntry();
</script>

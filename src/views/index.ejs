<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

  <div class="container">
    <h1>合約管理系統</h1>
    <div id="auth-section">
      <h2>鑫囍探索旅行社合約管理系統登入</h2>
      <form id="login-form">
        <div class="form-group">
          <label for="employee_id">員工編號:</label>
          <input type="text" id="employee_id" name="employee_id" value="admin" required>
        </div>
        <div class="form-group">
          <label for="password">密碼:</label>
          <input type="password" id="password" name="password" value="password" required>
        </div>
        <button type="button" id="login-btn">登入</button>
      </form>
    </div>

    <div id="data-section" class="hidden">
      <h2>你好, <span id="user-id"></span>!</h2>
      <button id="get-templates-btn">取得合約範本</button>
      <button id="logout-btn">登出</button>
    </div>

    <div id="result-section">
      <h3>資料</h3>
      <pre id="results"></pre>
    </div>
  </div>

  <script>
    const authSection = document.getElementById('auth-section');
    const dataSection = document.getElementById('data-section');
    const resultSection = document.getElementById('result-section');
    
    const loginBtn = document.getElementById('login-btn');
    const getTemplatesBtn = document.getElementById('get-templates-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const resultsEl = document.getElementById('results');
    const userIdEl = document.getElementById('user-id');
    const employeeIdInput = document.getElementById('employee_id');
    const passwordInput = document.getElementById('password');

    let token = localStorage.getItem('token');
    console.log('Script loaded. Initial token from localStorage:', token);


    // 登录逻辑 - 监听按钮点击
    loginBtn.addEventListener('click', async () => {
      console.log('Login button clicked.');
      resultsEl.textContent = '正在登入...';
      
      const data = {
        employee_id: employeeIdInput.value,
        password: passwordInput.value,
      };
      console.log('Login data:', data);

      if (!data.employee_id || !data.password) {
        resultsEl.textContent = '請輸入員工編號和密碼。';
        return;
      }

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        
        console.log('Login API response received:', response);
        const result = await response.json();
        console.log('Login API response body:', result);

        if (!response.ok) {
          throw new Error(result.message || `HTTP error! status: ${response.status}`);
        }

        token = result.token;
        localStorage.setItem('token', token);
        console.log('Token received and stored:', token);

        console.log('Calling showLoggedInState...');
        showLoggedInState(data.employee_id);
        resultsEl.textContent = '登入成功！現在可以點擊按鈕取得資料。';

      } catch (error) {
        console.error('Login failed with error:', error);
        resultsEl.textContent = `登入失敗: ${error.message}`;
      }
    });

    // 获取模板
    getTemplatesBtn.addEventListener('click', async () => {
      console.log('Get Templates button clicked.');
      if (!token) {
        console.log('No token found for getting templates.');
        resultsEl.textContent = '請先登入。';
        return;
      }
      resultsEl.textContent = '載入中...';
      try {
        const response = await fetch('/api/templates', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('Get Templates API response received:', response);
        const result = await response.json();
        console.log('Get Templates API response body:', result);

        if (!response.ok) {
          throw new Error(result.message || '取得資料失敗');
        }
        resultsEl.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        console.error('Get templates failed with error:', error);
        resultsEl.textContent = `錯誤: ${error.message}`;
        if (error.message.includes('token')) {
            logout();
        }
      }
    });

    // 登出
    logoutBtn.addEventListener('click', () => {
        console.log('Logout button clicked.');
        logout();
    });
    
    function logout() {
        console.log('Executing logout function.');
        token = null;
        localStorage.removeItem('token');
        showLoggedOutState();
        resultsEl.textContent = '已登出。';
    }

    function showLoggedInState(userId) {
        console.log('Executing showLoggedInState for user:', userId);
        authSection.classList.add('hidden');
        dataSection.classList.remove('hidden');
        userIdEl.textContent = userId;
        console.log('UI updated to logged-in state.');
    }

    function showLoggedOutState() {
        console.log('Executing showLoggedOutState.');
        authSection.classList.remove('hidden');
        dataSection.classList.add('hidden');
        userIdEl.textContent = '';
        console.log('UI updated to logged-out state.');
    }

    // 页面加载时检查 token
    if (token) {
        console.log('Token found on page load. Attempting to decode and update UI.');
        try {
            // Move all decoding logic inside the try block for safety
            const payload = token.split('.')[1];
            if (!payload) throw new Error('Invalid token format');
            const decoded = JSON.parse(atob(payload));
            if (!decoded.user || !decoded.user.employee_id) throw new Error('Invalid token payload');

            showLoggedInState(decoded.user.employee_id);
            resultsEl.textContent = '已登入，可以取得資料。';
        } catch (e) {
            console.error('Failed to decode token on page load. Clearing invalid token.', e);
            logout();
        }
    } else {
        console.log('No token found on page load.');
    }

  </script>
</body>
</html>

<%- include('partials/header') %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>我的合約</h1>
    <div>
      <span>你好, <%= user.full_name || user.name %></span>
      <a href="/sales/password" class="btn btn-outline-primary btn-sm ms-2">變更密碼</a>
      <a href="/logout" class="btn btn-secondary btn-sm ms-2">登出</a>
    </div>
  </div>

  <div class="mb-4 d-flex flex-wrap gap-2">
    <a href="/sales/contracts/new" class="btn btn-primary">＋ 新增合約</a>
    <a href="/sales/contracts/bulk" class="btn btn-outline-primary">批次新增合約</a>
  </div>

  <% if (flashMessage) { %>
    <div class="alert alert-success" role="alert">
      <%= flashMessage %>
    </div>
    <% } %>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <form class="row g-3 align-items-end" method="GET" action="/sales">
            <div class="col-md-3">
              <label class="form-label">開始日期</label>
              <input type="date" class="form-control" name="start_date" value="<%= filters?.start_date %>">
            </div>
            <div class="col-md-3">
              <label class="form-label">結束日期</label>
              <input type="date" class="form-control" name="end_date" value="<%= filters?.end_date %>">
            </div>
            <div class="col-md-3">
              <label class="form-label">狀態</label>
              <select name="status" class="form-select">
                <option value="ALL" <%=filters?.status==='ALL' ? 'selected' : '' %>>全部</option>
                <option value="PENDING_APPROVAL" <%=filters?.status==='PENDING_APPROVAL' ? 'selected' : '' %>>待審核
                </option>
                <option value="PENDING_SIGNATURE" <%=filters?.status==='PENDING_SIGNATURE' ? 'selected' : '' %>>待簽署
                </option>
                <option value="SIGNED" <%=filters?.status==='SIGNED' ? 'selected' : '' %>>已簽署</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="limit" class="form-label">每頁顯示</label>
              <select name="limit" id="limit" class="form-select" onchange="this.form.submit()">
                <option value="10" <%=filters.limit==10 ? 'selected' : '' %>>10 筆</option>
                <option value="20" <%=filters.limit==20 ? 'selected' : '' %>>20 筆</option>
                <option value="30" <%=filters.limit==30 ? 'selected' : '' %>>30 筆</option>
              </select>
            </div>
            <div class="col-md-1 d-flex gap-2">
              <button type="submit" class="btn btn-primary w-100">篩選</button>
              <a href="/sales" class="btn btn-outline-secondary w-100">清除</a>
            </div>
          </form>
          <p class="text-muted small mb-0 mt-2">預設顯示最近三個月內的合約，您可依需求調整範圍。</p>
        </div>
      </div>

      <!-- Contract List Section -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h2>合約列表</h2>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead>
                <tr>
                  <th style="min-width: 120px;">客戶名稱</th>
                  <th style="min-width: 160px;">合約屬性</th>
                  <th>狀態</th>
                  <th>建立日期</th>
                  <th style="width: 360px;">操作</th>
                </tr>
              </thead>
              <tbody>
                <% if(contracts && contracts.length> 0) { %>
                  <% contracts.forEach(contract=> { %>
                    <tr>
                      <td>
                        <%= contract.client_name || '-' %>
                      </td>
                      <td>
                        <%= contract.template_name || '-' %>
                      </td>
                      <td>
                        <% if (contract.status==='SIGNED' ) { %>
                          <span class="badge bg-success">已簽署</span>
                          <% } else if (contract.status==='PENDING_APPROVAL' ) { %>
                            <span class="badge bg-info text-dark">待主管審核</span>
                            <% } else if (contract.status==='REJECTED' ) { %>
                              <span class="badge bg-danger">審核駁回</span>
                              <% } else if (contract.status==='PENDING_SIGNATURE' ) { %>
                                <span class="badge bg-warning text-dark">待簽署</span>
                                <% } else if (contract.status==='DRAFT' ) { %>
                                  <span class="badge bg-secondary">草稿</span>
                                  <% } else if (contract.status==='CANCELLED' ) { %>
                                    <span class="badge bg-danger">已作廢</span>
                                    <% } else { %>
                                      <span class="badge bg-light text-dark">
                                        <%= contract.status %>
                                      </span>
                                      <% } %>
                      </td>
                      <td>
                        <%= new Date(contract.created_at).toLocaleDateString() %>
                      </td>
                      <td>
                        <a href="/sales/contracts/<%= contract.id %>" class="btn btn-sm btn-outline-info">詳情</a>
                        <% if (contract.status !=='SIGNED' ) { %>
                          <a href="/sales/contracts/<%= contract.id %>/edit"
                            class="btn btn-sm btn-outline-warning">編輯</a>
                          <% if (contract.status !=='CANCELLED' ) { %>
                            <form action="/sales/contracts/<%= contract.id %>/cancel" method="POST" class="d-inline"
                              onsubmit="return confirm('確定要作廢此合約嗎？');">
                              <button type="submit" class="btn btn-sm btn-outline-danger">作廢</button>
                            </form>
                            <% } %>
                              <% } %>
                      </td>
                    </tr>
                    <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="4" class="text-center">沒有任何合約</td>
                        </tr>
                        <% } %>
              </tbody>
            </table>

            <% if (pagination) { %>
              <!-- Pagination Controls -->
              <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                  <li class="page-item <%= pagination.current == 1 ? 'disabled' : '' %>">
                    <a class="page-link"
                      href="/sales?page=<%= pagination.current - 1 %>&status=<%= filters.status %>&limit=<%= filters.limit %>&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>">上一頁</a>
                  </li>

                  <% for(let i=1; i <=pagination.total; i++) { %>
                    <li class="page-item <%= pagination.current == i ? 'active' : '' %>">
                      <a class="page-link"
                        href="/sales?page=<%= i %>&status=<%= filters.status %>&limit=<%= filters.limit %>&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>">
                        <%= i %>
                      </a>
                    </li>
                    <% } %>

                      <li class="page-item <%= pagination.current == pagination.total ? 'disabled' : '' %>">
                        <a class="page-link"
                          href="/sales?page=<%= pagination.current + 1 %>&status=<%= filters.status %>&limit=<%= filters.limit %>&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>">下一頁</a>
                      </li>
                </ul>
              </nav>
              <% } %>
          </div>
        </div>
      </div>

      <%- include('partials/footer') %>
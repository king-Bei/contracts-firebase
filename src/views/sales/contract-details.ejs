<%- include('../partials/header') %>
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">合約詳情</h1>
    <p class="text-muted mb-0">合約 ID：<%= contract.id %></p>
  </div>
  <div>
    <a href="/sales" class="btn btn-outline-secondary">返回列表</a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-5">
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        <strong>合約資訊</strong>
      </div>
      <div class="card-body">
        <p class="mb-2"><strong>客戶名稱：</strong><%= contract.client_name || '-' %></p>
        <p class="mb-2"><strong>範本：</strong><%= contract.template_name %></p>
        <p class="mb-2"><strong>狀態：</strong>
          <% if (contract.status === 'SIGNED') { %>
            <span class="badge bg-success">已簽署</span>
          <% } else if (contract.status === 'PENDING_SIGNATURE') { %>
            <span class="badge bg-warning text-dark">待簽署</span>
          <% } else { %>
            <span class="badge bg-secondary"><%= contract.status %></span>
          <% } %>
        </p>
        <p class="mb-2"><strong>建立時間：</strong><%= new Date(contract.created_at).toLocaleString() %></p>
        <% if (contract.signed_at) { %>
          <p class="mb-0"><strong>簽署時間：</strong><%= new Date(contract.signed_at).toLocaleString() %></p>
        <% } %>
        <% if (contract.status !== 'SIGNED' && contract.status !== 'CANCELLED') { %>
          <form action="/sales/contracts/<%= contract.id %>/cancel" method="POST" class="mt-3" onsubmit="return confirm('確定要作廢此合約嗎？');">
            <button type="submit" class="btn btn-outline-danger w-100">作廢合約</button>
          </form>
        <% } %>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>簽署資訊</strong>
      </div>
      <div class="card-body">
        <p class="mb-2">請將以下連結與驗證碼提供給客戶。</p>
        <div class="mb-3">
          <label class="form-label">簽署短連結</label>
          <div class="input-group mb-2">
            <input type="text" readonly class="form-control" id="short-share-link" value="<%= shortShareLink %>">
            <button class="btn btn-outline-primary" type="button" id="copy-short-share-link">複製</button>
          </div>
          <div class="form-text">如需完整網址，可使用：<code><%= shareLink %></code></div>
        </div>
        <div class="alert alert-success" role="alert">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>客戶驗證碼：</strong> <kbd><%= plaintextCode || 'N/A' %></kbd>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="copy-code" <%= plaintextCode ? '' : 'disabled' %>>
              複製驗證碼
            </button>
          </div>
          <div class="small text-muted mt-2">驗證碼將同步顯示於此頁，方便業務員再次確認。</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>合約內容預覽</strong>
      </div>
      <div class="card-body">
        <div class="border rounded p-3 bg-light" style="min-height: 240px; white-space: pre-wrap;">
          <%- previewContent %>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<script>
  const copyShortLinkBtn = document.getElementById('copy-short-share-link');
  const copyCodeBtn = document.getElementById('copy-code');

  if (copyShortLinkBtn) {
    copyShortLinkBtn.addEventListener('click', async () => {
      const linkInput = document.getElementById('short-share-link');
      try {
        await navigator.clipboard.writeText(linkInput.value);
        copyShortLinkBtn.textContent = '已複製';
        setTimeout(() => copyShortLinkBtn.textContent = '複製', 1500);
      } catch (e) {
        alert('無法複製，請手動選取文字。');
      }
    });
  }

  if (copyCodeBtn) {
    copyCodeBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText('<%= plaintextCode || "" %>');
        copyCodeBtn.textContent = '已複製';
        setTimeout(() => copyCodeBtn.textContent = '複製驗證碼', 1500);
      } catch (e) {
        alert('無法複製，請手動選取驗證碼。');
      }
    });
  }
</script>

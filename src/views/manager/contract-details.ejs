<%- include('../partials/header') %>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">合約詳情審核</h1>
            <p class="text-muted mb-0">合約 ID：<%= contract.id %>
            </p>
        </div>
        <div>
            <a href="/manager/dashboard" class="btn btn-outline-secondary">返回列表</a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Sidebar: Contract Info and Actions -->
        <div class="col-lg-5 order-lg-1">
            <div class="card shadow-sm mb-4 anim-fade-up">
                <div class="card-header">
                    <strong>合約資訊</strong>
                </div>
                <div class="card-body">
                    <p class="mb-2"><strong>客戶名稱：</strong>
                        <%= contract.client_name || '-' %>
                    </p>
                    <p class="mb-2"><strong>合約範本：</strong>
                        <%= contract.template_name %>
                    </p>
                    <p class="mb-2"><strong>負責業務：</strong>
                        <%= contract.salesperson_name %>
                    </p>
                    <p class="mb-2"><strong>當前狀態：</strong>
                        <% if (contract.status==='PENDING_APPROVAL' ) { %>
                            <span class="badge bg-info text-dark">待審核</span>
                            <% } else if (contract.status==='REJECTED' ) { %>
                                <span class="badge bg-danger">審核駁回</span>
                                <% } else if (contract.status==='PENDING_SIGNATURE' ) { %>
                                    <span class="badge bg-warning text-dark">待簽署</span>
                                    <% } else if (contract.status==='SIGNED' ) { %>
                                        <span class="badge bg-success">已簽署</span>
                                        <% } else { %>
                                            <span class="badge bg-secondary">
                                                <%= contract.status %>
                                            </span>
                                            <% } %>
                    </p>
                    <p class="mb-0"><strong>建立時間：</strong>
                        <%= new Date(contract.created_at).toLocaleString() %>
                    </p>

                    <% if (contract.status==='PENDING_APPROVAL' ) { %>
                        <div class="mt-4 pt-3 border-top">
                            <form action="/manager/contracts/<%= contract.id %>/approve" method="POST" class="mb-2">
                                <button type="submit" class="btn btn-success w-100 py-2 shadow-sm"
                                    onclick="return confirm('確定要核准此合約嗎？');">
                                    <i class="bi bi-check-circle me-1"></i> 核准合約
                                </button>
                            </form>
                            <button type="button" class="btn btn-outline-danger w-100 py-2" data-bs-toggle="modal"
                                data-bs-target="#rejectModal">
                                <i class="bi bi-x-circle me-1"></i> 駁回合約
                            </button>
                        </div>
                        <% } %>
                </div>
            </div>

            <!-- Signing Info if already approved/signed -->
            <% if (contract.status==='PENDING_SIGNATURE' || contract.status==='SIGNED' ) { %>
                <div class="card shadow-sm mb-4 anim-fade-up" style="animation-delay: 0.1s;">
                    <div class="card-header">
                        <strong>簽署連結與代碼</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small text-muted">客戶驗證碼</label>
                            <div class="p-2 bg-light border rounded text-center">
                                <span class="h4 font-monospace mb-0">
                                    <%= contract.verification_code_plaintext || 'N/A' %>
                                </span>
                            </div>
                        </div>
                        <p class="small text-muted mb-0">如需查看簽署進度或連結，可與業務員核對。</p>
                    </div>
                </div>
                <% } %>
        </div>

        <!-- Main Content: Preview -->
        <div class="col-lg-7 order-lg-0">
            <div class="card shadow-sm anim-fade-up">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>合約內容預覽 (預覽樣式)</strong>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                            <i class="bi bi-printer"></i> 列印
                        </button>
                    </div>
                </div>
                <div class="card-body bg-light p-4" id="manager-preview-container">
                    <% if (contract.template_logo_url) { %>
                        <div class="text-center mb-4">
                            <img src="<%= contract.template_logo_url %>" alt="Company Logo" class="img-fluid"
                                style="max-height: 80px;">
                        </div>
                        <% } %>
                            <div class="contract-preview bg-white border shadow-sm p-4 p-md-5"
                                style="min-height: 800px;">
                                <%- previewContent %>
                            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="/manager/contracts/<%= contract.id %>/reject" method="POST">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="rejectModalLabel">駁回合約</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="rejectReason" class="form-label font-bold">請輸入駁回原因：</label>
                            <textarea class="form-control" id="rejectReason" name="reason" rows="4"
                                placeholder="請具體列出合約哪些地方需要修改，方便業務員修正..." required></textarea>
                            <div class="form-text mt-2 text-danger">
                                <i class="bi bi-info-circle"></i> 駁回後，合約狀態將變為「已駁回」，業務員修改後可重新送審。
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-danger">確認駁回</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
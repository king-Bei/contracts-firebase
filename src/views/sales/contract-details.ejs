<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .contract-preview {
            border: 1px solid #ccc;
            padding: 20px;
            background-color: #f8f9fa;
            white-space: pre-wrap; /* 保留換行與空白 */
            font-family: monospace;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar', { user: user }) %>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>合約詳情</h1>
            <a href="/sales/dashboard" class="btn btn-secondary">返回儀表板</a>
        </div>

        <!-- 顯示簽署連結與驗證碼的區塊 -->
        <% if (contract.status === 'PENDING_SIGNATURE' || contract.status === 'SIGNED') { %>
            <div class="alert alert-info">
                <h5>簽署資訊</h5>
                <p><strong>簽署連結:</strong> 
                    <input type="text" readonly class="form-control" value="<%= `${req.protocol}://${req.get('host')}/sign/${contract.signing_token}` %>">
                </p>
                <% if (plainVerificationCode) { %>
                    <div class="alert alert-success">
                        <p class="mb-0"><strong>客戶驗證碼:</strong> <kbd><%= plainVerificationCode %></kbd></p>
                        <small>請將以上連結與驗證碼提供給客戶。驗證碼只會顯示這一次，請妥善記錄。</small>
                    </div>
                <% } %>
            </div>
        <% } %>

        <div class="card mb-4">
            <div class="card-header">
                合約資訊
            </div>
            <div class="card-body">
                <p><strong>合約 ID:</strong> <%= contract.id %></p>
                <p><strong>客戶名稱:</strong> <%= contract.customer_name %></p>
                <p><strong>客戶 Email:</strong> <%= contract.customer_email %></p>
                <p><strong>狀態:</strong> 
                    <% if (contract.status === 'SIGNED') { %>
                        <span class="badge bg-success">已簽署</span>
                    <% } else if (contract.status === 'PENDING_SIGNATURE') { %>
                        <span class="badge bg-warning text-dark">待簽署</span>
                    <% } else if (contract.status === 'DRAFT') { %>
                        <span class="badge bg-secondary">草稿</span>
                    <% } else { %>
                        <span class="badge bg-light text-dark"><%= contract.status %></span>
                    <% } %>
                </p>
                <p><strong>建立時間:</strong> <%= new Date(contract.created_at).toLocaleString() %></p>
                <% if (contract.signed_at) { %>
                    <p><strong>簽署時間:</strong> <%= new Date(contract.signed_at).toLocaleString() %></p>
                <% } %>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>合約內容預覽</span>
                <!-- 只有在草稿狀態下才顯示操作按鈕 -->
                <% if (contract.status === 'DRAFT') { %>
                    <div>
                        <a href="/sales/contracts/<%= contract.id %>/edit" class="btn btn-warning btn-sm">編輯</a>
                        <form action="/sales/contracts/<%= contract.id %>/generate-link" method="POST" onsubmit="return confirm('您確定要產生簽署連結嗎？產生後合約內容將無法修改。');" class="d-inline">
                            <button type="submit" class="btn btn-success btn-sm">產生簽署連結</button>
                        </form>
                    </div>
                <% } %>
            </div>
            <div class="card-body">
                <div class="contract-preview">
                    <%- previewContent %>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

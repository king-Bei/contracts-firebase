<%- include('partials/header') %>

<div class="container mt-4">
    <h1 class="mb-4">編輯合約範本</h1>

    <div class="card shadow-sm">
        <div class="card-body">
            <form action="/admin/templates/edit/<%= template.id %>" method="POST">
                <div class="mb-3">
                    <label for="name" class="form-label">合約屬性</label>
                    <input type="text" class="form-control" id="name" name="name" value="<%= template.name %>" required>
                </div>

                <div class="mb-3">
                    <label for="logo_url" class="form-label">公司 LOGO 圖片網址（選填）</label>
                    <input type="url" class="form-control" id="logo_url" name="logo_url" value="<%= template.logo_url || '' %>" placeholder="https://example.com/logo.png">
                    <div class="form-text">設定後會顯示於合約預覽與簽署頁面頂部。</div>
                </div>

                <div class="mb-3">
                    <label for="content" class="form-label">合約內容</label>
                    <p class="form-text">
                        使用 <code>{{variable_key}}</code> 格式插入變數（例：<code>{{client_name}}</code>）。可直接編輯或上傳檔案填入內容，亦可插入圖片。
                    </p>
                    <div class="d-flex flex-column flex-md-row gap-2 mb-2">
                        <input type="file" accept=".txt,.html,.htm" class="form-control" id="content-upload">
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-secondary" id="detect-variables">從內容偵測變數</button>
                            <button type="button" class="btn btn-outline-primary" id="insert-image">插入圖片</button>
                        </div>
                    </div>
                    <div id="content-editor" class="form-control bg-light" style="min-height: 280px;" contenteditable="true"></div>
                    <textarea class="d-none" id="content" name="content" required><%= template.content %></textarea>
                </div>

                <div class="mb-3">
                    <h5 class="mt-4">範本變數</h5>
                    <p class="form-text">
                        變數名稱建議使用英數與底線 (例：client_name)，顯示標籤則為給使用者看的中文說明，可依需求選擇輸入型態（單行、多行或勾選）。
                    </p>
                    <div id="variables-container">
                        <% if (variables && variables.length > 0) { %>
                            <% variables.forEach((variable, index) => { %>
                                <div class="row mb-2 g-2">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" placeholder="變數名稱" name="var_key_<%= index %>" value="<%= variable.key %>" required>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" placeholder="顯示標籤" name="var_label_<%= index %>" value="<%= variable.label %>" required>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" name="var_type_<%= index %>">
                                            <% const vType = (variable.type || 'text').toLowerCase(); %>
                                            <option value="text" <%= vType === 'text' ? 'selected' : '' %>>單行文字</option>
                                            <option value="textarea" <%= vType === 'textarea' ? 'selected' : '' %>>多行文字</option>
                                            <option value="checkbox" <%= vType === 'checkbox' ? 'selected' : '' %>>勾選</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-danger w-100 remove-variable">移除</button>
                                    </div>
                                </div>
                            <% }) %>
                        <% } %>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <button type="button" class="btn btn-outline-secondary" id="add-variable">新增變數</button>
                        <button type="button" class="btn btn-outline-primary" id="insert-placeholder">插入選擇的變數佔位符</button>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" value="on" id="is_active" name="is_active" <%= template.is_active ? 'checked' : '' %>>
                    <label class="form-check-label" for="is_active">啟用此範本</label>
                </div>

                <input type="hidden" name="variables" id="variables-json">

                <div class="d-flex justify-content-end">
                    <a href="/admin/templates" class="btn btn-secondary me-2">取消</a>
                    <button type="submit" class="btn btn-primary">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let variableCount = <%= variables?.length || 0 %>;

function buildRow(key = '', label = '', type = 'text') {
    const row = document.createElement('div');
    row.classList.add('row', 'mb-2', 'g-2');
    row.innerHTML = `
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="變數名稱" name="var_key_${variableCount}" value="${key}" required>
        </div>
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="顯示標籤" name="var_label_${variableCount}" value="${label}" required>
        </div>
        <div class="col-md-3">
            <select class="form-select" name="var_type_${variableCount}">
                <option value="text" ${type === 'text' ? 'selected' : ''}>單行文字</option>
                <option value="textarea" ${type === 'textarea' ? 'selected' : ''}>多行文字</option>
                <option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>勾選</option>
            </select>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger w-100 remove-variable">移除</button>
        </div>
    `;
    variableCount++;
    return row;
}

document.addEventListener('DOMContentLoaded', () => {
    const variablesContainer = document.getElementById('variables-container');
    const addVariableButton = document.getElementById('add-variable');
    const variablesJsonInput = document.getElementById('variables-json');
    const form = document.querySelector('form');
    const contentEditor = document.getElementById('content-editor');
    const contentInput = document.getElementById('content');
    const uploadInput = document.getElementById('content-upload');
    const detectButton = document.getElementById('detect-variables');
    const insertPlaceholderButton = document.getElementById('insert-placeholder');
    const insertImageButton = document.getElementById('insert-image');

    // 初始化編輯器內容
    function setEditorContent(html) {
        contentEditor.innerHTML = html || '';
    }

    function getEditorContent() {
        return (contentEditor.innerHTML || '').trim();
    }

    setEditorContent(contentInput.value || '');

    addVariableButton.addEventListener('click', () => {
        variablesContainer.appendChild(buildRow());
    });

    variablesContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-variable')) {
            e.target.closest('.row').remove();
        }
    });

    uploadInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const result = evt.target?.result || '';
            const isHtml = (file.type && file.type.includes('html')) || /\.html?$/i.test(file.name || '');
            if (isHtml) {
                setEditorContent(result);
            } else {
                contentEditor.innerText = result;
            }
        };
        reader.readAsText(file);
    });

    function syncContentToInput() {
        contentInput.value = getEditorContent();
    }

    function extractPlaceholders(text) {
        const matches = [...(text || '').matchAll(/{{\s*([a-zA-Z0-9_]+)\s*}}/g)];
        return Array.from(new Set(matches.map(m => m[1])));
    }

    detectButton.addEventListener('click', () => {
        const placeholders = extractPlaceholders(getEditorContent());
        if (!placeholders.length) {
            alert('未找到符合 {{placeholder}} 格式的變數。');
            return;
        }
        const existingKeys = new Set(
            Array.from(variablesContainer.querySelectorAll('input[name^="var_key_"]'))
                .map(input => input.value.trim())
                .filter(Boolean)
        );
        let created = 0;
        placeholders.forEach(key => {
            if (!existingKeys.has(key)) {
                variablesContainer.appendChild(buildRow(key, key));
                created++;
            }
        });
        alert(created > 0 ? `已加入 ${created} 個新變數。` : '所有偵測到的變數都已存在。');
    });

    insertPlaceholderButton.addEventListener('click', () => {
        const keys = Array.from(variablesContainer.querySelectorAll('input[name^="var_key_"]'))
            .map(input => input.value.trim())
            .filter(Boolean);
        if (!keys.length) {
            alert('請先新增至少一個變數。');
            return;
        }
        const suggestion = keys[0];
        const selected = prompt('要插入的變數名稱（系統會自動加上 {{ }}）', suggestion);
        if (!selected) return;
        const placeholder = `{{${selected}}}`;
        contentEditor.focus();
        if (document.execCommand) {
            document.execCommand('insertText', false, placeholder);
        } else {
            contentEditor.innerText += placeholder;
        }
    });

    insertImageButton.addEventListener('click', () => {
        const url = prompt('請輸入圖片網址');
        if (!url) return;
        const alt = prompt('圖片說明（選填）') || '';
        const imgTag = `<img src="${url}" alt="${alt}" style="max-width: 100%;">`;
        contentEditor.focus();
        if (document.execCommand) {
            document.execCommand('insertHTML', false, imgTag);
        } else {
            contentEditor.innerHTML += imgTag;
        }
    });

    form.addEventListener('submit', (e) => {
        const variables = [];
        const rows = variablesContainer.querySelectorAll('.row');
        for (const row of rows) {
            const keyInput = row.querySelector('input[name^="var_key_"]');
            const labelInput = row.querySelector('input[name^="var_label_"]');
            const typeInput = row.querySelector('select[name^="var_type_"]');
            const key = keyInput?.value.trim();
            const label = labelInput?.value.trim();
            const type = (typeInput?.value || 'text').toLowerCase();

            if (key && label) {
                if (!/^[a-zA-Z0-9_]+$/.test(key)) {
                    alert('變數名稱只能包含英數與底線。');
                    e.preventDefault();
                    return;
                }
                const normalizedType = ['text', 'textarea', 'checkbox'].includes(type) ? type : 'text';
                variables.push({ key, label, type: normalizedType });
            }
        }

        syncContentToInput();
        if (!contentInput.value) {
            alert('請填寫合約內容');
            e.preventDefault();
            return;
        }
        variablesJsonInput.value = JSON.stringify(variables);
    });
});
</script>

<%- include('partials/footer') %>

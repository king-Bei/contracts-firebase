<%- include('../partials/header') %>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">åˆç´„è©³æƒ…</h1>
      <p class="text-muted mb-0">åˆç´„ IDï¼š<%= contract.id %>
      </p>
    </div>
    <div>
      <a href="/sales" class="btn btn-outline-secondary">è¿”å›åˆ—è¡¨</a>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <strong>åˆç´„è³‡è¨Š</strong>
        </div>
        <div class="card-body">
          <p class="mb-2"><strong>å®¢æˆ¶åç¨±ï¼š</strong>
            <%= contract.client_name || '-' %>
          </p>
          <p class="mb-2"><strong>åˆç´„ï¼š</strong>
            <%= contract.template_name %>
          </p>
          <p class="mb-2"><strong>ç‹€æ…‹ï¼š</strong>
            <% if (contract.status==='SIGNED' ) { %>
              <span class="badge bg-success">å·²ç°½ç½²</span>
              <% } else if (contract.status==='PENDING_SIGNATURE' ) { %>
                <span class="badge bg-warning text-dark">å¾…ç°½ç½²</span>
                <% } else { %>
                  <span class="badge bg-secondary">
                    <%= contract.status %>
                  </span>
                  <% } %>
          </p>
          <p class="mb-2"><strong>å»ºç«‹æ™‚é–“ï¼š</strong>
            <%= new Date(contract.created_at).toLocaleString() %>
          </p>
          <% if (contract.signed_at) { %>
            <p class="mb-0"><strong>ç°½ç½²æ™‚é–“ï¼š</strong>
              <%= new Date(contract.signed_at).toLocaleString() %>
            </p>
            <% } %>
              <% if (contract.status !=='SIGNED' && contract.status !=='CANCELLED' ) { %>
                <form action="/sales/contracts/<%= contract.id %>/cancel" method="POST" class="mt-3"
                  onsubmit="return confirm('ç¢ºå®šè¦ä½œå»¢æ­¤åˆç´„å—ï¼Ÿ');">
                  <button type="submit" class="btn btn-outline-danger w-100">ä½œå»¢åˆç´„</button>
                </form>
                <% } %>
        </div>
      </div>

      <% if (contract.status==='SIGNED' && contract.signature_image) { %>
        <div class="card shadow-sm mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>ç°½åæ†‘è­‰</strong>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary" id="download-pdf">ä¸‹è¼‰å®Œæ•´ PDF</button>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="print-contract">åˆ—å°</button>
              <a class="btn btn-sm btn-outline-success" href="<%= contract.signature_image %>"
                download="contract-<%= contract.id %>-signature.png">ä¸‹è¼‰ç°½ååœ–æª”</a>
            </div>
          </div>
          <div class="card-body text-center">
            <img src="<%= contract.signature_image %>" alt="å®¢æˆ¶ç°½å" class="img-fluid border rounded"
              style="max-height: 200px;">
            <div class="text-muted small mt-2">ç°½ç½²æ™‚é–“ï¼š<%= new Date(contract.signed_at).toLocaleString() %>
            </div>
          </div>
        </div>
        <% } %>

          <% if (contract.rejection_reason && contract.status==='REJECTED' ) { %>
            <div class="alert alert-danger shadow-sm mb-4">
              <h4 class="alert-heading">ğŸš« åˆç´„å·²è¢«é§å›</h4>
              <p class="mb-0">ä¸»ç®¡é§å›åŸå› ï¼š</p>
              <div class="mt-2 p-3 bg-light rounded text-danger border border-danger border-opacity-25">
                <%= contract.rejection_reason %>
              </div>
              <hr>
              <div class="d-flex justify-content-end">
                <a href="/sales/contracts/<%= contract.id %>/edit" class="btn btn-danger">ä¿®æ”¹ä¸¦é‡æ–°é€å¯©</a>
              </div>
            </div>
            <% } %>

              <% if (contract.status==='PENDING_SIGNATURE' || contract.status==='SIGNED' ) { %>
                <div class="card shadow-sm">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>ç°½ç½²è³‡è¨Š</strong>
                  </div>
                  <div class="card-body">
                    <p class="mb-2">è«‹å°‡ä»¥ä¸‹é€£çµèˆ‡é©—è­‰ç¢¼æä¾›çµ¦å®¢æˆ¶ã€‚</p>
                    <div class="mb-3">
                      <label class="form-label">ç°½ç½²çŸ­é€£çµ</label>
                      <div class="input-group mb-2">
                        <input type="text" readonly class="form-control" id="short-share-link"
                          value="<%= shortShareLink %>">
                        <button class="btn btn-outline-primary" type="button" id="copy-short-share-link">è¤‡è£½</button>
                      </div>
                      <div class="form-text">å¦‚éœ€å®Œæ•´ç¶²å€ï¼Œå¯ä½¿ç”¨ï¼š<code><%= shareLink %></code></div>
                    </div>
                    <div class="alert alert-success" role="alert">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <strong>å®¢æˆ¶é©—è­‰ç¢¼ï¼š</strong> <kbd>
                            <%= plaintextCode || 'N/A' %>
                          </kbd>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="copy-code" <%=plaintextCode
                          ? '' : 'disabled' %>>
                          è¤‡è£½é©—è­‰ç¢¼
                        </button>
                      </div>
                      <div class="small text-muted mt-2">é©—è­‰ç¢¼å°‡åŒæ­¥é¡¯ç¤ºæ–¼æ­¤é ï¼Œæ–¹ä¾¿æ¥­å‹™å“¡å†æ¬¡ç¢ºèªã€‚</div>
                    </div>
                  </div>
                </div>
                <% } %>

                  <% if (contract.status==='PENDING_SIGNATURE' || contract.status==='SIGNED' ) { %>
                    <div class="card shadow-sm mt-4">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>ç™¼é€ç°½ç½²è¨Šæ¯</strong>
                        <small class="text-muted">å¯è‡ªè¡Œä¿®æ”¹å…§å®¹</small>
                      </div>
                      <div class="card-body">
                        <p class="text-muted mb-2">å¯è¤‡è£½ä»¥ä¸‹æ–‡å­—è²¼çµ¦å®¢æˆ¶ï¼Œå«çŸ­é€£çµèˆ‡é©—è­‰ç¢¼ã€‚</p>
                        <textarea class="form-control" id="share-message" rows="4" placeholder="è¼¸å…¥è¦å‚³é€çµ¦å®¢æˆ¶çš„å…§å®¹"></textarea>
                        <div class="d-flex justify-content-end gap-2 mt-3">
                          <button type="button" class="btn btn-outline-secondary" id="reset-message">é‡è¨­è¨Šæ¯</button>
                          <button type="button" class="btn btn-primary" id="copy-message">è¤‡è£½è¨Šæ¯</button>
                        </div>
                        <div class="form-text mt-2">é è¨­è¨Šæ¯æœƒè‡ªå‹•å¸¶å…¥å®¢æˆ¶å§“åã€åˆç´„ã€çŸ­é€£çµèˆ‡é©—è­‰ç¢¼ã€‚</div>
                      </div>
                    </div>
                    <% } %>
    </div>

    <div class="col-lg-7">
      <div class="card shadow-sm" id="contract-preview-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>åˆç´„å…§å®¹é è¦½</strong>
          <div class="d-flex gap-2">
            <a class="btn btn-sm btn-outline-primary" href="/sales/contracts/<%= contract.id %>/pdf" target="_blank"
              rel="noopener">ä¸‹è¼‰å®Œæ•´ PDF</a>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="print-preview">åˆ—å°</button>
          </div>
        </div>
        <div class="card-body" id="contract-preview-wrapper">
          <% if (contract.template_logo_url) { %>
            <div class="text-center mb-3">
              <img src="<%= contract.template_logo_url %>" alt="å…¬å¸ LOGO" class="img-fluid" style="max-height: 80px;">
            </div>
            <% } %>
              <div class="border rounded p-3 bg-light"
                style="min-height: 240px; max-height: 520px; overflow: auto; white-space: pre-wrap;">
                <%- previewContent %>
              </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>

    <script>
      const copyShortLinkBtn = document.getElementById('copy-short-share-link');
      const copyCodeBtn = document.getElementById('copy-code');
      const shareMessageInput = document.getElementById('share-message');
      const resetMessageBtn = document.getElementById('reset-message');
      const copyMessageBtn = document.getElementById('copy-message');

      // Define variables from server-side EJS
      const contractClientName = "<%= contract.client_name || 'å®¢æˆ¶' %>";
      const contractTemplateName = "<%= contract.template_name %>";
      const contractShortLink = "<%= shortShareLink %>";
      const contractVerificationCode = "<%= plaintextCode || '' %>";

      function buildDefaultMessage() {
        const codeLine = contractVerificationCode ? `\né©—è­‰ç¢¼ï¼š${contractVerificationCode}` : '';
        return `${contractClientName} ${contractTemplateName} \n${contractShortLink} ${codeLine}`;
      }

      if (shareMessageInput) {
        shareMessageInput.value = buildDefaultMessage();
      }

      if (copyShortLinkBtn) {
        copyShortLinkBtn.addEventListener('click', async () => {
          const linkInput = document.getElementById('short-share-link');
          if (!linkInput) return;
          try {
            await navigator.clipboard.writeText(linkInput.value);
            const originalText = copyShortLinkBtn.textContent;
            copyShortLinkBtn.textContent = 'å·²è¤‡è£½';
            copyShortLinkBtn.classList.remove('btn-outline-primary');
            copyShortLinkBtn.classList.add('btn-success');
            setTimeout(() => {
              copyShortLinkBtn.textContent = originalText;
              copyShortLinkBtn.classList.remove('btn-success');
              copyShortLinkBtn.classList.add('btn-outline-primary');
            }, 1500);
          } catch (e) {
            console.error(e);
            alert('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—ã€‚');
          }
        });
      }

      if (copyCodeBtn) {
        copyCodeBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText('<%= plaintextCode || "" %>');
            copyCodeBtn.textContent = 'å·²è¤‡è£½';
            setTimeout(() => copyCodeBtn.textContent = 'è¤‡è£½é©—è­‰ç¢¼', 1500);
          } catch (e) {
            alert('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–é©—è­‰ç¢¼ã€‚');
          }
        });
      }

      if (resetMessageBtn && shareMessageInput) {
        resetMessageBtn.addEventListener('click', () => {
          shareMessageInput.value = buildDefaultMessage();
          shareMessageInput.focus();
        });
      }

      if (copyMessageBtn && shareMessageInput) {
        copyMessageBtn.addEventListener('click', async () => {
          const text = shareMessageInput.value?.trim();
          if (!text) {
            alert('è«‹å…ˆè¼¸å…¥è¦å‚³é€çš„è¨Šæ¯å…§å®¹ã€‚');
            return;
          }
          try {
            await navigator.clipboard.writeText(text);
            copyMessageBtn.textContent = 'å·²è¤‡è£½';
            setTimeout(() => copyMessageBtn.textContent = 'è¤‡è£½è¨Šæ¯', 1500);
          } catch (e) {
            alert('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—ã€‚');
          }
        });
      }

      const printBtn = document.getElementById('print-contract');
      if (printBtn) {
        printBtn.addEventListener('click', () => window.print());
      }

      const printPreviewBtn = document.getElementById('print-preview');
      if (printPreviewBtn) {
        printPreviewBtn.addEventListener('click', () => window.print());
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
      function prepareClone(element) {
        const clone = element.cloneNode(true);
        clone.style.maxHeight = 'none';
        clone.style.overflow = 'visible';
        clone.style.position = 'absolute';
        clone.style.left = '-9999px';
        clone.style.top = '0';
        clone.style.width = `${element.scrollWidth || element.offsetWidth}px`;
        clone.style.height = `${element.scrollHeight || element.offsetHeight}px`;
        const scrollable = clone.querySelector('.border');
        if (scrollable) {
          scrollable.style.maxHeight = 'none';
          scrollable.style.overflow = 'visible';
          scrollable.style.height = 'auto';
          scrollable.style.width = `${scrollable.scrollWidth || scrollable.offsetWidth}px`;
        }
        document.body.appendChild(clone);
        return clone;
      }

      async function downloadPdf(elementId, filename) {
        const wrapper = document.getElementById(elementId);
        if (!wrapper) return;
        const scrollable = wrapper.querySelector('.border') || wrapper;
        const clone = prepareClone(scrollable);
        const canvas = await html2canvas(clone, {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff',
          scrollY: -window.scrollY,
        });
        clone.remove();
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'pt', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
        const imgWidth = imgProps.width * ratio;
        const imgHeight = imgProps.height * ratio;

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save(filename);
      }

      const pdfButtons = document.querySelectorAll('#download-pdf, #download-pdf-top');
      pdfButtons.forEach(btn => btn?.addEventListener('click', () => downloadPdf('contract-preview-card', `contract-${'<%= contract.id %>'}.pdf`)));
    </script>